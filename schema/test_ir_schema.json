{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/test-ir.schema.json",
  "title": "Lightweight Test IR Schema",
  "type": "object",
  "required": ["meta", "steps"],
  "additionalProperties": false,

  "properties": {

    "meta": {
      "type": "object",
      "required": ["id", "name"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "priority": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "variables": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": ["type", "value"],
        "additionalProperties": false,
        "properties": {
          "type": {
            "type": "string",
            "enum": ["int", "float", "string", "bool"]
          },
          "value": {}
        }
      }
    },

    "preconditions": {
      "type": "array",
      "items": { "$ref": "#/$defs/stateCondition" }
    },

    "steps": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/step" }
    },

    "postconditions": {
      "type": "array",
      "items": { "$ref": "#/$defs/stateCondition" }
    }

  },

  "$defs": {

    "step": {
      "type": "object",
      "required": ["type", "target"],
      "additionalProperties": false,
      "properties": {

        "id": {
          "type": "string"
        },

        "type": {
          "type": "string",
          "enum": ["action", "check", "wait"]
        },

        "target": {
          "type": "string",
          "description": "Target object name",
          "enum": ["phone", "screen", "key", "touch_key", "program key", "call log"]
        },

        "operation": {
          "type": "string",
          "description": "Semantic action name (not API name)"
        },

        "params": {
          "type": "object",
          "additionalProperties": true
        },

        "property": {
          "type": "string"
        },

        "operator": {
          "type": "string",
          "enum": ["==", "!=", ">", "<", ">=", "<=", "contains", "matches"]
        },

        "value": {},

        "condition": {
          "$ref": "#/$defs/stateCondition"
        },

        "timeout": {
          "type": "integer",
          "minimum": 0
        },

        "interval": {
          "type": "integer",
          "minimum": 0
        }

      },

      "allOf": [

        {
          "if": {
            "properties": { "type": { "const": "action" } }
          },
          "then": {
            "required": ["operation"]
          }
        },

        {
          "if": {
            "properties": { "type": { "const": "check" } }
          },
          "then": {
            "required": ["property", "operator", "value"]
          }
        },

        {
          "if": {
            "properties": { "type": { "const": "wait" } }
          },
          "then": {
            "required": ["condition"]
          }
        }

      ]
    },

    "stateCondition": {
      "type": "object",
      "required": ["target", "property", "operator", "value"],
      "additionalProperties": false,
      "properties": {

        "target": {
          "type": "string",
          "enum": ["phone", "screen", "program key"]
        },

        "property": {
          "type": "string"
        },

        "operator": {
          "type": "string",
          "enum": ["==", "!=", ">", "<", ">=", "<=", "contains", "matches"]
        },

        "value": {}
      }
    }

  }
}
